/*
 * Canvas Of War
 * An online 2d multiplayer shooting game
 * https://github.com/7andahalf/
 */

var global_game = null;
var messages = [];
var resolution = 1;
$(function() {start_game();});

function start_game() {
    var g = new game();
    global_game = g;
    //$(window).resize(function() {g.resize();});
    g.keys = [];
    g.players = [];
    g.name = prompt("Please enter your name", "Vinay");
    g.socket = io();
    socketRecieve();
    socketRecieveMessage();
    g.start();
}

function socketRecieveMessage(){
  global_game.socket.on('message', function(msg){
    messages.push(msg);
  });
}

function socketRecieve(){
  global_game.socket.on('game', function(msg){
    if(msg.name == global_game.name){return;}
    var pr = 0;
    for(var i in global_game.players){
      if(global_game.players[i].name == msg.name){pr=global_game.players[i];}
    }
    if(pr == 0){
      lastmess = 0;
      socketSend();

      var gplayer = new player(global_game, { image: img_res('man.png'), x: 5, y: 8, width: 2.6 , type: "static", density: 0});
      gplayer.gun = new ogun(global_game, { image: img_res('gun.png'), x:6, y: 8.5, width: 4 , height: 1.5})

      global_game.game_objects.push(gplayer);
      global_game.game_objects.push(gplayer.gun);

      def = new Box2D.Dynamics.Joints.b2RevoluteJointDef();
      def.Initialize(gplayer.body,gplayer.gun.body,new b2Vec2(5,8.5));
      var joint = global_game.world.CreateJoint(def);
      gplayer.name = msg.name;
      gplayer.body.SetPosition(new b2Vec2(msg.plposx, msg.plposy));
      gplayer.gun.body.SetAngle(msg.gunang);
      gplayer.gun.name = msg.name;

      global_game.players.push(gplayer);

    }else{
      pr.body.SetPosition(new b2Vec2(msg.plposx, msg.plposy));
      pr.gun.body.SetAngle(msg.gunang);
      while(msg.bull > 0){
        pr.gun.shoot(pr.body.GetPosition(),msg.gunang);
          msg.bull--;
        }
      }
  });
}

function socketMessage(k){
  global_game.socket.emit('message', k);
}

var lastmess = 0;
function socketSend(){

  function roundd(v){
    return Math.round(v * 10)/10;
  }

  function rounde(v){
    return Math.round(v * 100)/100;
  }

  plx = global_game.player.body.GetPosition().x;
  ply = global_game.player.body.GetPosition().y;
  gan = global_game.gun.body.GetAngle();
  bull = global_game.gun.bull;

  if(lastmess == 0 || Math.abs(lastmess.plposx - plx) > 0.1 || Math.abs(lastmess.plposy - ply) > 0.1 || Math.abs(lastmess.gunang - gan) > 0.05 || bull > 0){
    lastmess = {name : global_game.name, plposx : roundd(plx),  plposy : roundd(ply), gunang: rounde(gan), bull: bull};
    global_game.socket.emit('game', {name : global_game.name, plposx : plx,  plposy : ply, gunang: gan, bull: bull}); 
    global_game.gun.bull = 0;
  }       
}

function game()
{
    this.fps = 60;
    this.scale = 20;
    this.game_objects = [];
    this.health = 100;
    this.ammunition = 100;
    this.booster = 100;
    this.to_destroy = [];
    this.time_elapsed = 0;
}

game.prototype.resize = function()
{
    var canvas = this.canvas;

    var w = $(window).outerWidth();
    var h = $(window).outerHeight();
    
    canvas.width(w);
    canvas.height(h);

    canvas.attr('width' , w * resolution);
    canvas.attr('height' , h * resolution);
    
    this.canvas_width = canvas.attr('width');
    this.canvas_height = canvas.attr('height');

    this.screen_height = 30;
    this.scale = this.canvas_height / this.screen_height;
    this.screen_width = this.canvas_width / this.scale;

    this.canvas.w = (global_game.canvas_width / (2 * global_game.scale));
    this.canvas.h = (global_game.canvas_height / (2 * global_game.scale));
}

game.prototype.setup = function()
{
    this.ctx = ctx = $('#canvas').get(0).getContext('2d');
    var canvas = $('#canvas');
    this.canvas = canvas;

    this.resize();

    var w = this.screen_width;
    var h = this.screen_height;

    this.create_box2d_world();

    this.world = this.box2d_world;
    this.element = canvas;
    this.context = ctx;

    this.context.scale(global_game.scale,global_game.scale);

    this.canvas.posx = this.canvas_width/(2 * this.scale);
    this.canvas.posy = this.canvas_height/(2 * this.scale);

    var obj = new Body(global_game, { color: "red", type: "static", x: 0, y: 0, height: 1000,  width: 0.5 });
    obj.tp = "dend";
    this.game_objects.push(obj);

    var obj = new Body(global_game, { color: "red", type: "static", x:450, y: 0, height: 1000,  width: 0.5});
    obj.tp = "dend";
    this.game_objects.push(obj);

    var obj = new Body(global_game, { color: "red", type: "static", x: 0, y: 0, height: 0.5, width: 900 });
    obj.tp = "dend";
    this.game_objects.push(obj);

    var obj = new Body(global_game, { color: "red", type: "static", x: 0, y: 500, height: 0.5, width: 900 });
    obj.tp = "dend";
    this.game_objects.push(obj);

    var x= 100,y = 100;

    var obj_one = {"rigidBodies":[{"name":"Name","imagePath":"../pcs/1.png","origin":{"x":0,"y":0},"polygons":[[{"x":0.1549999862909317,"y":0.1312500387430191},{"x":0.17750002443790436,"y":0.10375002771615982},{"x":0.21500001847743988,"y":0.07875005155801773},{"x":0.2800000309944153,"y":0.0662500336766243}],[{"x":0.2800000309944153,"y":0.0662500336766243},{"x":0.3175000250339508,"y":0.04125005379319191},{"x":0.3750000298023224,"y":0.04375002160668373}],[{"x":0.5600000619888306,"y":0.03375006094574928},{"x":0.6225000619888306,"y":0.008750052191317081},{"x":0.70250004529953,"y":0.01125004980713129},{"x":0.762499988079071,"y":0.03625005856156349},{"x":0.79749995470047,"y":0.07125002890825272},{"x":0.8299999833106995,"y":0.12125004082918167}],[{"x":0.8700000643730164,"y":0.15625004470348358},{"x":0.9024999737739563,"y":0.18375001847743988},{"x":0.9099999666213989,"y":0.23875002562999725}],[{"x":0.9274999499320984,"y":0.2562500536441803},{"x":0.9550000429153442,"y":0.27125003933906555},{"x":0.9575000405311584,"y":0.29375001788139343}],[{"x":0.9575000405311584,"y":0.29375001788139343},{"x":0.9474999308586121,"y":0.3087500333786011},{"x":0.9150000214576721,"y":0.33625003695487976},{"x":0.8575000166893005,"y":0.33875003457069397},{"x":0.9099999666213989,"y":0.23875002562999725},{"x":0.9274999499320984,"y":0.2562500536441803}],[{"x":0.6100000739097595,"y":0.3412500321865082},{"x":0.5149999856948853,"y":0.3462500274181366},{"x":0.5024999976158142,"y":0.04375002160668373},{"x":0.5600000619888306,"y":0.03375006094574928},{"x":0.8299999833106995,"y":0.12125004082918167}],[{"x":0.8299999833106995,"y":0.12125004082918167},{"x":0.8700000643730164,"y":0.15625004470348358},{"x":0.9099999666213989,"y":0.23875002562999725},{"x":0.8575000166893005,"y":0.33875003457069397},{"x":0.7924999594688416,"y":0.3487500250339508},{"x":0.7200000882148743,"y":0.3487500250339508},{"x":0.6100000739097595,"y":0.3412500321865082}],[{"x":0.5149999856948853,"y":0.3462500274181366},{"x":0.44249996542930603,"y":0.3537500202655792},{"x":0.35750001668930054,"y":0.36125001311302185},{"x":0.27000004053115845,"y":0.3537500202655792},{"x":0.1824999898672104,"y":0.33375000953674316},{"x":0.11250001937150955,"y":0.15625004470348358}],[{"x":0.11250001937150955,"y":0.15625004470348358},{"x":0.1549999862909317,"y":0.1312500387430191},{"x":0.2800000309944153,"y":0.0662500336766243},{"x":0.3750000298023224,"y":0.04375002160668373},{"x":0.5024999976158142,"y":0.04375002160668373},{"x":0.5149999856948853,"y":0.3462500274181366}],[{"x":0.1824999898672104,"y":0.33375000953674316},{"x":0.10000003129243851,"y":0.3162500560283661},{"x":0.052499983459711075,"y":0.27625003457069397},{"x":0.04249999299645424,"y":0.21625004708766937},{"x":0.07499996572732925,"y":0.17125003039836884},{"x":0.11250001937150955,"y":0.15625004470348358}]],"circles":[],"shapes":[{"type":"POLYGON","vertices":[{"x":0.04249999299645424,"y":0.21625004708766937},{"x":0.052499983459711075,"y":0.27625003457069397},{"x":0.10000003129243851,"y":0.3162500560283661},{"x":0.1824999898672104,"y":0.33375000953674316},{"x":0.27000004053115845,"y":0.3537500202655792},{"x":0.35750001668930054,"y":0.36125001311302185},{"x":0.44249996542930603,"y":0.3537500202655792},{"x":0.5149999856948853,"y":0.3462500274181366},{"x":0.6100000739097595,"y":0.3412500321865082},{"x":0.7200000882148743,"y":0.3487500250339508},{"x":0.7924999594688416,"y":0.3487500250339508},{"x":0.8575000166893005,"y":0.33875003457069397},{"x":0.9150000214576721,"y":0.33625003695487976},{"x":0.9474999308586121,"y":0.3087500333786011},{"x":0.9575000405311584,"y":0.29375001788139343},{"x":0.9550000429153442,"y":0.27125003933906555},{"x":0.9274999499320984,"y":0.2562500536441803},{"x":0.9099999666213989,"y":0.23875002562999725},{"x":0.9024999737739563,"y":0.18375001847743988},{"x":0.8700000643730164,"y":0.15625004470348358},{"x":0.8299999833106995,"y":0.12125004082918167},{"x":0.79749995470047,"y":0.07125002890825272},{"x":0.762499988079071,"y":0.03625005856156349},{"x":0.70250004529953,"y":0.01125004980713129},{"x":0.6225000619888306,"y":0.008750052191317081},{"x":0.5600000619888306,"y":0.03375006094574928},{"x":0.5024999976158142,"y":0.04375002160668373},{"x":0.4449999928474426,"y":0.04375002160668373},{"x":0.3750000298023224,"y":0.04375002160668373},{"x":0.3175000250339508,"y":0.04125005379319191},{"x":0.2800000309944153,"y":0.0662500336766243},{"x":0.21500001847743988,"y":0.07875005155801773},{"x":0.17750002443790436,"y":0.10375002771615982},{"x":0.1549999862909317,"y":0.1312500387430191},{"x":0.11250001937150955,"y":0.15625004470348358},{"x":0.07499996572732925,"y":0.17125003039836884}]}]}],"dynamicObjects":[]};
    for(var j in obj_one.rigidBodies[0].polygons){
      for(var i in obj_one.rigidBodies[0].polygons[j]){
        obj_one.rigidBodies[0].polygons[j][i].x *= 29;
        obj_one.rigidBodies[0].polygons[j][i].y *= -29;
      }
      bdy = new Body(global_game, { color: "red", shape: "polygon", type: "static",height: 5, width: 120,
                          points: obj_one.rigidBodies[0].polygons[j].reverse(),
                          x: x + 2.4, y: y+ 22})
      this.game_objects.push(bdy);
      bdy.tp = "nodraw";
    }

    var obj_two = {"rigidBodies":[{"name":"Name","imagePath":"../pcs/2.png","origin":{"x":0,"y":0},"polygons":[[{"x":0.5300000309944153,"y":0.02625003643333912},{"x":0.6800000071525574,"y":0.008750052191317081},{"x":0.8125000596046448,"y":0.008750052191317081},{"x":0.9325000047683716,"y":0.07125002890825272}],[{"x":0.9325000047683716,"y":0.07125002890825272},{"x":0.9699999690055847,"y":0.08625001460313797},{"x":0.9750000238418579,"y":0.11125002056360245},{"x":0.9325000047683716,"y":0.14875005185604095},{"x":0.7850000262260437,"y":0.16875003278255463},{"x":0.64000004529953,"y":0.17375005781650543}],[{"x":0.64000004529953,"y":0.17375005781650543},{"x":0.4375000298023224,"y":0.16625000536441803},{"x":0.20000000298023224,"y":0.1362500637769699},{"x":0.23249997198581696,"y":0.03625005856156349},{"x":0.33250001072883606,"y":0.0212500412017107},{"x":0.5300000309944153,"y":0.02625003643333912},{"x":0.9325000047683716,"y":0.07125002890825272}],[{"x":0.20000000298023224,"y":0.1362500637769699},{"x":0.14000003039836884,"y":0.15125004947185516},{"x":0.035000029951334,"y":0.1287500411272049},{"x":0.014999986626207829,"y":0.09125003963708878},{"x":0.030000003054738045,"y":0.03625005856156349},{"x":0.23249997198581696,"y":0.03625005856156349}]],"circles":[],"shapes":[{"type":"POLYGON","vertices":[{"x":0.014999986626207829,"y":0.09125003963708878},{"x":0.035000029951334,"y":0.1287500411272049},{"x":0.14000003039836884,"y":0.15125004947185516},{"x":0.20000000298023224,"y":0.1362500637769699},{"x":0.4375000298023224,"y":0.16625000536441803},{"x":0.64000004529953,"y":0.17375005781650543},{"x":0.7850000262260437,"y":0.16875003278255463},{"x":0.9325000047683716,"y":0.14875005185604095},{"x":0.9750000238418579,"y":0.11125002056360245},{"x":0.9699999690055847,"y":0.08625001460313797},{"x":0.9325000047683716,"y":0.07125002890825272},{"x":0.8125000596046448,"y":0.008750052191317081},{"x":0.6800000071525574,"y":0.008750052191317081},{"x":0.5300000309944153,"y":0.02625003643333912},{"x":0.33250001072883606,"y":0.0212500412017107},{"x":0.23249997198581696,"y":0.03625005856156349},{"x":0.11000002175569534,"y":0.03625005856156349},{"x":0.030000003054738045,"y":0.03625005856156349}]}]}],"dynamicObjects":[]};
     for(var j in obj_two.rigidBodies[0].polygons){
      for(var i in obj_two.rigidBodies[0].polygons[j]){
        obj_two.rigidBodies[0].polygons[j][i].x *= 33;
        obj_two.rigidBodies[0].polygons[j][i].y *= -33;
      }
      bdy = new Body(global_game, { color: "red", shape: "polygon", type: "static",height: 5, width: 120,
                          points: obj_two.rigidBodies[0].polygons[j].reverse(),
                          x: x + 2.4, y: y+ 44})
      this.game_objects.push(bdy);
      bdy.tp = "nodraw";
    }

    var obj_three = {"rigidBodies":[{"name":"Name","imagePath":"../pcs/3.png","origin":{"x":0,"y":0},"polygons":[[{"x":0.7150000333786011,"y":0.04625001922249794},{"x":0.8000000715255737,"y":0.01125004980713129},{"x":0.8725000023841858,"y":0.018750043585896492}],[{"x":0.8725000023841858,"y":0.018750043585896492},{"x":0.98499995470047,"y":0.04125005379319191},{"x":0.9675000309944153,"y":0.1962500363588333},{"x":0.9550000429153442,"y":0.2262500375509262},{"x":0.8025000095367432,"y":0.22875003516674042},{"x":0.6600000262260437,"y":0.20875002443790436},{"x":0.6299999952316284,"y":0.07875005155801773},{"x":0.7150000333786011,"y":0.04625001922249794}],[{"x":0.6600000262260437,"y":0.20875002443790436},{"x":0.5875000357627869,"y":0.23125003278255463},{"x":0.4350000023841858,"y":0.23375000059604645},{"x":0.2175000160932541,"y":0.22875003516674042},{"x":0.05750000849366188,"y":0.21625004708766937},{"x":0.052499983459711075,"y":0.18375001847743988}],[{"x":0.052499983459711075,"y":0.18375001847743988},{"x":0.20250003039836884,"y":0.12125004082918167},{"x":0.2775000035762787,"y":0.11125002056360245},{"x":0.4350000023841858,"y":0.09125003963708878},{"x":0.6299999952316284,"y":0.07875005155801773},{"x":0.6600000262260437,"y":0.20875002443790436}]],"circles":[],"shapes":[{"type":"POLYGON","vertices":[{"x":0.052499983459711075,"y":0.18375001847743988},{"x":0.05750000849366188,"y":0.21625004708766937},{"x":0.2175000160932541,"y":0.22875003516674042},{"x":0.4350000023841858,"y":0.23375000059604645},{"x":0.5875000357627869,"y":0.23125003278255463},{"x":0.6600000262260437,"y":0.20875002443790436},{"x":0.8025000095367432,"y":0.22875003516674042},{"x":0.9550000429153442,"y":0.2262500375509262},{"x":0.9675000309944153,"y":0.1962500363588333},{"x":0.98499995470047,"y":0.04125005379319191},{"x":0.8725000023841858,"y":0.018750043585896492},{"x":0.8000000715255737,"y":0.01125004980713129},{"x":0.7150000333786011,"y":0.04625001922249794},{"x":0.6299999952316284,"y":0.07875005155801773},{"x":0.4350000023841858,"y":0.09125003963708878},{"x":0.2775000035762787,"y":0.11125002056360245},{"x":0.20250003039836884,"y":0.12125004082918167}]}]}],"dynamicObjects":[]};
    for(var j in obj_three.rigidBodies[0].polygons){
      for(var i in obj_three.rigidBodies[0].polygons[j]){
        obj_three.rigidBodies[0].polygons[j][i].x *= 27;
        obj_three.rigidBodies[0].polygons[j][i].y *= -27;
      }
      bdy = new Body(global_game, { color: "red", shape: "polygon", type: "static",height: 5, width: 120,
                          points: obj_three.rigidBodies[0].polygons[j].reverse(),
                          x: x + 2.4, y: y+ 76})
      this.game_objects.push(bdy);
      bdy.tp = "nodraw";
    }

    var obj_four ={"rigidBodies":[{"name":"Name","imagePath":"../pcs/4.png","origin":{"x":0,"y":0},"polygons":[[{"x":0.64000004529953,"y":0.05625006929039955},{"x":0.8149999976158142,"y":0.013750077225267887},{"x":0.9000000357627869,"y":0.008750052191317081},{"x":0.9375000596046448,"y":0.02625003643333912},{"x":0.9750000238418579,"y":0.07125002890825272},{"x":0.9550000429153442,"y":0.12375000864267349},{"x":0.9150000214576721,"y":0.1362500637769699},{"x":0.7724999785423279,"y":0.15125004947185516}],[{"x":0.2825000584125519,"y":0.2787500321865082},{"x":0.1574999839067459,"y":0.3412500321865082},{"x":0.10749999433755875,"y":0.36375001072883606},{"x":0.045000020414590836,"y":0.351250022649765},{"x":0.014999986626207829,"y":0.3187500536441803},{"x":0.07499996572732925,"y":0.2487500160932541},{"x":0.2825000584125519,"y":0.161250039935112}],[{"x":0.2825000584125519,"y":0.161250039935112},{"x":0.44749999046325684,"y":0.10125003010034561},{"x":0.4375000298023224,"y":0.2262500375509262},{"x":0.2825000584125519,"y":0.2787500321865082}],[{"x":0.44749999046325684,"y":0.10125003010034561},{"x":0.64000004529953,"y":0.05625006929039955},{"x":0.7724999785423279,"y":0.15125004947185516},{"x":0.5725000500679016,"y":0.21625004708766937},{"x":0.4375000298023224,"y":0.2262500375509262}]],"circles":[],"shapes":[{"type":"POLYGON","vertices":[{"x":0.014999986626207829,"y":0.3187500536441803},{"x":0.045000020414590836,"y":0.351250022649765},{"x":0.10749999433755875,"y":0.36375001072883606},{"x":0.1574999839067459,"y":0.3412500321865082},{"x":0.2825000584125519,"y":0.2787500321865082},{"x":0.4375000298023224,"y":0.2262500375509262},{"x":0.5725000500679016,"y":0.21625004708766937},{"x":0.7724999785423279,"y":0.15125004947185516},{"x":0.9150000214576721,"y":0.1362500637769699},{"x":0.9550000429153442,"y":0.12375000864267349},{"x":0.9750000238418579,"y":0.07125002890825272},{"x":0.9375000596046448,"y":0.02625003643333912},{"x":0.9000000357627869,"y":0.008750052191317081},{"x":0.8149999976158142,"y":0.013750077225267887},{"x":0.64000004529953,"y":0.05625006929039955},{"x":0.44749999046325684,"y":0.10125003010034561},{"x":0.2825000584125519,"y":0.161250039935112},{"x":0.07499996572732925,"y":0.2487500160932541}]}]}],"dynamicObjects":[]};
     for(var j in obj_four.rigidBodies[0].polygons){
      for(var i in obj_four.rigidBodies[0].polygons[j]){
        obj_four.rigidBodies[0].polygons[j][i].x *= 29;
        obj_four.rigidBodies[0].polygons[j][i].y *= -29;
      }
      bdy = new Body(global_game, { color: "red", shape: "polygon", type: "static",height: 5, width: 120,
                          points: obj_four.rigidBodies[0].polygons[j].reverse(),
                          x: x + 39, y: y+ 52})
      this.game_objects.push(bdy);
      bdy.tp = "nodraw";
    }

    var obj_five ={"rigidBodies":[{"name":"Name","imagePath":"../pcs/5.png","origin":{"x":0,"y":0},"polygons":[[{"x":0.6525000929832458,"y":0.02625003643333912},{"x":0.8000000715255737,"y":0.02375003881752491},{"x":0.8974999785423279,"y":0.04625001922249794},{"x":0.9699999690055847,"y":0.10875005275011063},{"x":0.9325000047683716,"y":0.1362500637769699},{"x":0.7875000834465027,"y":0.13875003159046173},{"x":0.6574999690055847,"y":0.13875003159046173}],[{"x":0.6574999690055847,"y":0.13875003159046173},{"x":0.4625000059604645,"y":0.1337500661611557},{"x":0.45499998331069946,"y":0.0212500412017107},{"x":0.6525000929832458,"y":0.02625003643333912}],[{"x":0.4625000059604645,"y":0.1337500661611557},{"x":0.30250000953674316,"y":0.1262500137090683},{"x":0.2874999940395355,"y":0.013750077225267887},{"x":0.45499998331069946,"y":0.0212500412017107}],[{"x":0.30250000953674316,"y":0.1262500137090683},{"x":0.12000001221895218,"y":0.17375005781650543},{"x":0.047500018030405045,"y":0.17375005781650543},{"x":0.02000001259148121,"y":0.1262500137090683},{"x":0.02499997802078724,"y":0.07375005632638931},{"x":0.08250001817941666,"y":0.04375002160668373},{"x":0.22249998152256012,"y":0.003750026458874345},{"x":0.2874999940395355,"y":0.013750077225267887}]],"circles":[],"shapes":[{"type":"POLYGON","vertices":[{"x":0.02000001259148121,"y":0.1262500137090683},{"x":0.047500018030405045,"y":0.17375005781650543},{"x":0.12000001221895218,"y":0.17375005781650543},{"x":0.30250000953674316,"y":0.1262500137090683},{"x":0.4625000059604645,"y":0.1337500661611557},{"x":0.6574999690055847,"y":0.13875003159046173},{"x":0.7875000834465027,"y":0.13875003159046173},{"x":0.9325000047683716,"y":0.1362500637769699},{"x":0.9699999690055847,"y":0.10875005275011063},{"x":0.8974999785423279,"y":0.04625001922249794},{"x":0.8000000715255737,"y":0.02375003881752491},{"x":0.6525000929832458,"y":0.02625003643333912},{"x":0.45499998331069946,"y":0.0212500412017107},{"x":0.2874999940395355,"y":0.013750077225267887},{"x":0.22249998152256012,"y":0.003750026458874345},{"x":0.08250001817941666,"y":0.04375002160668373},{"x":0.02499997802078724,"y":0.07375005632638931}]}]}],"dynamicObjects":[]};
    for(var j in obj_five.rigidBodies[0].polygons){
      for(var i in obj_five.rigidBodies[0].polygons[j]){
        obj_five.rigidBodies[0].polygons[j][i].x *= 35;
        obj_five.rigidBodies[0].polygons[j][i].y *= -35;
      }
      bdy = new Body(global_game, { color: "red", shape: "polygon", type: "static",height: 5, width: 120,
                          points: obj_five.rigidBodies[0].polygons[j].reverse(),
                          x: x + 32, y: y+ 75.5})          
      this.game_objects.push(bdy);
      bdy.tp = "nodraw";
    }

    var obj_six ={"rigidBodies":[{"name":"Name","imagePath":"../pcs/6.png","origin":{"x":0,"y":0},"polygons":[[{"x":0.12500004470348358,"y":0.10875005275011063},{"x":0.1849999874830246,"y":0.0662500336766243},{"x":0.2849999964237213,"y":0.07875005155801773}],[{"x":0.2849999964237213,"y":0.07875005155801773},{"x":0.33500003814697266,"y":0.05875003710389137},{"x":0.5399999618530273,"y":0.051250044256448746}],[{"x":0.8650000095367432,"y":0.17625005543231964},{"x":0.7450000643730164,"y":0.17375005781650543},{"x":0.7225000262260437,"y":0.01625007577240467},{"x":0.8075000643730164,"y":0.008750052191317081},{"x":0.8875000476837158,"y":0.04375002160668373},{"x":0.9375000596046448,"y":0.0987500324845314},{"x":0.9625000357627869,"y":0.161250039935112}],[{"x":0.9625000357627869,"y":0.161250039935112},{"x":0.9449999928474426,"y":0.18125002086162567},{"x":0.8650000095367432,"y":0.17625005543231964}],[{"x":0.7450000643730164,"y":0.17375005781650543},{"x":0.6225000619888306,"y":0.1962500363588333},{"x":0.5399999618530273,"y":0.051250044256448746},{"x":0.6449999809265137,"y":0.018750043585896492},{"x":0.7225000262260437,"y":0.01625007577240467}],[{"x":0.6225000619888306,"y":0.1962500363588333},{"x":0.550000011920929,"y":0.2237500101327896},{"x":0.37000003457069397,"y":0.2237500101327896},{"x":0.21500001847743988,"y":0.20625005662441254},{"x":0.03749999776482582,"y":0.16875003278255463}],[{"x":0.03749999776482582,"y":0.16875003278255463},{"x":0.03749999776482582,"y":0.14375002682209015},{"x":0.12500004470348358,"y":0.10875005275011063},{"x":0.2849999964237213,"y":0.07875005155801773},{"x":0.5399999618530273,"y":0.051250044256448746},{"x":0.6225000619888306,"y":0.1962500363588333}]],"circles":[],"shapes":[{"type":"POLYGON","vertices":[{"x":0.03749999776482582,"y":0.14375002682209015},{"x":0.03749999776482582,"y":0.16875003278255463},{"x":0.21500001847743988,"y":0.20625005662441254},{"x":0.37000003457069397,"y":0.2237500101327896},{"x":0.550000011920929,"y":0.2237500101327896},{"x":0.6225000619888306,"y":0.1962500363588333},{"x":0.7450000643730164,"y":0.17375005781650543},{"x":0.8650000095367432,"y":0.17625005543231964},{"x":0.9449999928474426,"y":0.18125002086162567},{"x":0.9625000357627869,"y":0.161250039935112},{"x":0.9375000596046448,"y":0.0987500324845314},{"x":0.8875000476837158,"y":0.04375002160668373},{"x":0.8075000643730164,"y":0.008750052191317081},{"x":0.7225000262260437,"y":0.01625007577240467},{"x":0.6449999809265137,"y":0.018750043585896492},{"x":0.5399999618530273,"y":0.051250044256448746},{"x":0.33500003814697266,"y":0.05875003710389137},{"x":0.2849999964237213,"y":0.07875005155801773},{"x":0.1849999874830246,"y":0.0662500336766243},{"x":0.12500004470348358,"y":0.10875005275011063}]}]}],"dynamicObjects":[]};
    for(var j in obj_six.rigidBodies[0].polygons){
      for(var i in obj_six.rigidBodies[0].polygons[j]){
        obj_six.rigidBodies[0].polygons[j][i].x *= 37;
        obj_six.rigidBodies[0].polygons[j][i].y *= -37;
      }
      bdy = new Body(global_game, { color: "red", shape: "polygon", type: "static",height: 5, width: 120,
                          points: obj_six.rigidBodies[0].polygons[j].reverse(),
                          x: x + 57, y: y+ 35})
      this.game_objects.push(bdy);
      bdy.tp = "nodraw";
    }

    var obj_seven ={"rigidBodies":[{"name":"Name","imagePath":"../pcs/7.png","origin":{"x":0,"y":0},"polygons":[[{"x":0.9050000309944153,"y":0.18125002086162567},{"x":0.8450000286102295,"y":0.2487500160932541},{"x":0.5975000262260437,"y":0.0212500412017107},{"x":0.7799999713897705,"y":0.008750052191317081},{"x":0.92249995470047,"y":0.031250033527612686}],[{"x":0.92249995470047,"y":0.031250033527612686},{"x":0.9800000786781311,"y":0.0987500324845314},{"x":0.9575000405311584,"y":0.14125002920627594},{"x":0.9050000309944153,"y":0.18125002086162567}],[{"x":0.9000000357627869,"y":0.45625001192092896},{"x":0.949999988079071,"y":0.5137500762939453},{"x":0.9599999785423279,"y":0.5537500381469727},{"x":0.9599999785423279,"y":0.5737500190734863},{"x":0.9074999690055847,"y":0.5787500143051147}],[{"x":0.9074999690055847,"y":0.5787500143051147},{"x":0.7850000262260437,"y":0.5787500143051147},{"x":0.8575000166893005,"y":0.3487500250339508},{"x":0.9000000357627869,"y":0.45625001192092896}],[{"x":0.6850000023841858,"y":0.5887500047683716},{"x":0.550000011920929,"y":0.6087499856948853},{"x":0.38750001788139343,"y":0.6012499928474426}],[{"x":0.30250000953674316,"y":0.606249988079071},{"x":0.20999999344348907,"y":0.6237499713897705},{"x":0.13250000774860382,"y":0.6012499928474426}],[{"x":0.13250000774860382,"y":0.6012499928474426},{"x":0.38750001788139343,"y":0.6012499928474426},{"x":0.30250000953674316,"y":0.606249988079071}],[{"x":0.13250000774860382,"y":0.6012499928474426},{"x":0.03250003233551979,"y":0.6037499904632568},{"x":0.01249998901039362,"y":0.5887500047683716},{"x":0.017500014975667,"y":0.5687499642372131},{"x":0.047500018030405045,"y":0.5162500143051147},{"x":0.07000000029802322,"y":0.5012500286102295}],[{"x":0.09750000387430191,"y":0.41875001788139343},{"x":0.09250000864267349,"y":0.32875004410743713},{"x":0.11749998480081558,"y":0.2787500321865082}],[{"x":0.11749998480081558,"y":0.2787500321865082},{"x":0.10499999672174454,"y":0.21875004470348358},{"x":0.20000000298023224,"y":0.03375006094574928}],[{"x":0.20000000298023224,"y":0.03375006094574928},{"x":0.3125,"y":0.008750052191317081},{"x":0.3774999678134918,"y":0.006250054109841585},{"x":0.5975000262260437,"y":0.0212500412017107},{"x":0.8450000286102295,"y":0.2487500160932541},{"x":0.8575000166893005,"y":0.3487500250339508},{"x":0.7850000262260437,"y":0.5787500143051147}],[{"x":0.7850000262260437,"y":0.5787500143051147},{"x":0.6850000023841858,"y":0.5887500047683716},{"x":0.38750001788139343,"y":0.6012499928474426},{"x":0.13250000774860382,"y":0.6012499928474426},{"x":0.0950000062584877,"y":0.46875},{"x":0.09750000387430191,"y":0.41875001788139343},{"x":0.11749998480081558,"y":0.2787500321865082},{"x":0.20000000298023224,"y":0.03375006094574928}],[{"x":0.13250000774860382,"y":0.6012499928474426},{"x":0.07000000029802322,"y":0.5012500286102295},{"x":0.0950000062584877,"y":0.46875}],[{"x":0.10499999672174454,"y":0.21875004470348358},{"x":0.06000003591179848,"y":0.14625002443790436},{"x":0.03250003233551979,"y":0.09625006467103958},{"x":0.06750000268220901,"y":0.06125003471970558},{"x":0.11499998718500137,"y":0.028750063851475716},{"x":0.20000000298023224,"y":0.03375006094574928}]],"circles":[],"shapes":[{"type":"POLYGON","vertices":[{"x":0.03250003233551979,"y":0.09625006467103958},{"x":0.06000003591179848,"y":0.14625002443790436},{"x":0.10499999672174454,"y":0.21875004470348358},{"x":0.11749998480081558,"y":0.2787500321865082},{"x":0.09250000864267349,"y":0.32875004410743713},{"x":0.09750000387430191,"y":0.41875001788139343},{"x":0.0950000062584877,"y":0.46875},{"x":0.07000000029802322,"y":0.5012500286102295},{"x":0.047500018030405045,"y":0.5162500143051147},{"x":0.017500014975667,"y":0.5687499642372131},{"x":0.01249998901039362,"y":0.5887500047683716},{"x":0.03250003233551979,"y":0.6037499904632568},{"x":0.13250000774860382,"y":0.6012499928474426},{"x":0.20999999344348907,"y":0.6237499713897705},{"x":0.30250000953674316,"y":0.606249988079071},{"x":0.38750001788139343,"y":0.6012499928474426},{"x":0.550000011920929,"y":0.6087499856948853},{"x":0.6850000023841858,"y":0.5887500047683716},{"x":0.7850000262260437,"y":0.5787500143051147},{"x":0.9074999690055847,"y":0.5787500143051147},{"x":0.9599999785423279,"y":0.5737500190734863},{"x":0.9599999785423279,"y":0.5537500381469727},{"x":0.949999988079071,"y":0.5137500762939453},{"x":0.9000000357627869,"y":0.45625001192092896},{"x":0.8575000166893005,"y":0.3487500250339508},{"x":0.8450000286102295,"y":0.2487500160932541},{"x":0.9050000309944153,"y":0.18125002086162567},{"x":0.9575000405311584,"y":0.14125002920627594},{"x":0.9800000786781311,"y":0.0987500324845314},{"x":0.92249995470047,"y":0.031250033527612686},{"x":0.7799999713897705,"y":0.008750052191317081},{"x":0.5975000262260437,"y":0.0212500412017107},{"x":0.3774999678134918,"y":0.006250054109841585},{"x":0.3125,"y":0.008750052191317081},{"x":0.20000000298023224,"y":0.03375006094574928},{"x":0.11499998718500137,"y":0.028750063851475716},{"x":0.06750000268220901,"y":0.06125003471970558}]}]}],"dynamicObjects":[]};
    for(var j in obj_seven.rigidBodies[0].polygons){
      for(var i in obj_seven.rigidBodies[0].polygons[j]){
        obj_seven.rigidBodies[0].polygons[j][i].x *= 43;
        obj_seven.rigidBodies[0].polygons[j][i].y *= -43;
      }
      bdy = new Body(global_game, { color: "red", shape: "polygon", type: "static",height: 5, width: 120,
                          points: obj_seven.rigidBodies[0].polygons[j].reverse(),
                          x: x + 71, y: y+ 75})
      this.game_objects.push(bdy);
      bdy.tp = "nodraw";
    }

    var obj_eight ={"rigidBodies":[{"name":"Name","imagePath":"../pcs/8.png","origin":{"x":0,"y":0},"polygons":[[{"x":0.8399999737739563,"y":0.15125004947185516},{"x":0.7775000333786011,"y":0.16875003278255463},{"x":0.690000057220459,"y":0.17125003039836884},{"x":0.5450000166893005,"y":0.1637500375509262}],[{"x":0.5450000166893005,"y":0.1637500375509262},{"x":0.6025000810623169,"y":0.03375006094574928},{"x":0.7875000834465027,"y":0.04375002160668373},{"x":0.9050000309944153,"y":0.08875004202127457},{"x":0.9625000357627869,"y":0.1337500661611557},{"x":0.9375000596046448,"y":0.14125002920627594},{"x":0.8399999737739563,"y":0.15125004947185516}],[{"x":0.5450000166893005,"y":0.1637500375509262},{"x":0.3225000202655792,"y":0.1587500423192978},{"x":0.382500022649765,"y":0.018750043585896492},{"x":0.48499998450279236,"y":0.013750077225267887},{"x":0.6025000810623169,"y":0.03375006094574928}],[{"x":0.3225000202655792,"y":0.1587500423192978},{"x":0.1849999874830246,"y":0.1587500423192978},{"x":0.07250002771615982,"y":0.15125004947185516},{"x":0.03749999776482582,"y":0.09375006705522537},{"x":0.21500001847743988,"y":0.01625007577240467},{"x":0.382500022649765,"y":0.018750043585896492}]],"circles":[],"shapes":[{"type":"POLYGON","vertices":[{"x":0.03749999776482582,"y":0.09375006705522537},{"x":0.07250002771615982,"y":0.15125004947185516},{"x":0.1849999874830246,"y":0.1587500423192978},{"x":0.3225000202655792,"y":0.1587500423192978},{"x":0.5450000166893005,"y":0.1637500375509262},{"x":0.690000057220459,"y":0.17125003039836884},{"x":0.7775000333786011,"y":0.16875003278255463},{"x":0.8399999737739563,"y":0.15125004947185516},{"x":0.9375000596046448,"y":0.14125002920627594},{"x":0.9625000357627869,"y":0.1337500661611557},{"x":0.9050000309944153,"y":0.08875004202127457},{"x":0.7875000834465027,"y":0.04375002160668373},{"x":0.6025000810623169,"y":0.03375006094574928},{"x":0.48499998450279236,"y":0.013750077225267887},{"x":0.382500022649765,"y":0.018750043585896492},{"x":0.21500001847743988,"y":0.01625007577240467}]}]}],"dynamicObjects":[]};
    for(var j in obj_eight.rigidBodies[0].polygons){
      for(var i in obj_eight.rigidBodies[0].polygons[j]){
        obj_eight.rigidBodies[0].polygons[j][i].x *= 37;
        obj_eight.rigidBodies[0].polygons[j][i].y *= -37;
      }
      bdy = new Body(global_game, { color: "red", shape: "polygon", type: "static",height: 5, width: 120,
                          points: obj_eight.rigidBodies[0].polygons[j].reverse(),
                          x: x + 118, y: y+ 76})
      this.game_objects.push(bdy);
      bdy.tp = "nodraw";
    }

    var obj_nine ={"rigidBodies":[{"name":"9","imagePath":"../pcs/9.png","origin":{"x":0,"y":0},"polygons":[[{"x":0.9166666269302368,"y":1.259469747543335},{"x":0.8712122440338135,"y":1.1496212482452393},{"x":0.833333432674408,"y":0.9678030014038086},{"x":0.8068182468414307,"y":0.6571969389915466},{"x":0.9166666269302368,"y":0.7746212482452393},{"x":0.9772727489471436,"y":1.0435606241226196},{"x":0.9696969985961914,"y":1.3049242496490479}],[{"x":0.9696969985961914,"y":1.3049242496490479},{"x":0.9621211886405945,"y":1.464015245437622},{"x":0.9166666269302368,"y":1.464015245437622},{"x":0.8939393758773804,"y":1.3958334922790527},{"x":0.9166666269302368,"y":1.259469747543335}],[{"x":0.8068182468414307,"y":0.6571969389915466},{"x":0.7803030610084534,"y":0.47537875175476074},{"x":0.8901516199111938,"y":0.5359848141670227},{"x":0.9166666269302368,"y":0.6117424964904785},{"x":0.9166666269302368,"y":0.7746212482452393}],[{"x":0.7803030610084534,"y":0.47537875175476074},{"x":0.7007575035095215,"y":0.25189393758773804},{"x":0.8446969985961914,"y":0.2178030014038086},{"x":0.8787878155708313,"y":0.32007575035095215},{"x":0.8901516199111938,"y":0.5359848141670227}],[{"x":0.5303030014038086,"y":0.1458333432674408},{"x":0.3787878751754761,"y":0.12689390778541565},{"x":0.3598484694957733,"y":0.03977271914482117},{"x":0.49242421984672546,"y":0.017045438289642334}],[{"x":0.49242421984672546,"y":0.017045438289642334},{"x":0.6818181276321411,"y":0.0018939077854156494},{"x":0.6325757503509521,"y":0.19507575035095215},{"x":0.5303030014038086,"y":0.1458333432674408}],[{"x":0.6818181276321411,"y":0.0018939077854156494},{"x":0.8143939971923828,"y":0.06249997019767761},{"x":0.8446969985961914,"y":0.2178030014038086},{"x":0.7007575035095215,"y":0.25189393758773804},{"x":0.6325757503509521,"y":0.19507575035095215}],[{"x":0.3787878751754761,"y":0.12689390778541565},{"x":0.22727271914482117,"y":0.13825756311416626},{"x":0.10606059432029724,"y":0.13446968793869019},{"x":0.037878721952438354,"y":0.11931818723678589},{"x":0.12499997019767761,"y":0.06628784537315369},{"x":0.3598484694957733,"y":0.03977271914482117}]],"circles":[],"shapes":[{"type":"POLYGON","vertices":[{"x":0.037878721952438354,"y":0.11931818723678589},{"x":0.10606059432029724,"y":0.13446968793869019},{"x":0.22727271914482117,"y":0.13825756311416626},{"x":0.3787878751754761,"y":0.12689390778541565},{"x":0.5303030014038086,"y":0.1458333432674408},{"x":0.6325757503509521,"y":0.19507575035095215},{"x":0.7007575035095215,"y":0.25189393758773804},{"x":0.7803030610084534,"y":0.47537875175476074},{"x":0.8068182468414307,"y":0.6571969389915466},{"x":0.833333432674408,"y":0.9678030014038086},{"x":0.8712122440338135,"y":1.1496212482452393},{"x":0.9166666269302368,"y":1.259469747543335},{"x":0.8939393758773804,"y":1.3958334922790527},{"x":0.9166666269302368,"y":1.464015245437622},{"x":0.9621211886405945,"y":1.464015245437622},{"x":0.9696969985961914,"y":1.3049242496490479},{"x":0.9772727489471436,"y":1.0435606241226196},{"x":0.9166666269302368,"y":0.7746212482452393},{"x":0.9166666269302368,"y":0.6117424964904785},{"x":0.8901516199111938,"y":0.5359848141670227},{"x":0.8787878155708313,"y":0.32007575035095215},{"x":0.8446969985961914,"y":0.2178030014038086},{"x":0.8143939971923828,"y":0.06249997019767761},{"x":0.6818181276321411,"y":0.0018939077854156494},{"x":0.49242421984672546,"y":0.017045438289642334},{"x":0.3598484694957733,"y":0.03977271914482117},{"x":0.12499997019767761,"y":0.06628784537315369}]}]}],"dynamicObjects":[]};
    for(var j in obj_nine.rigidBodies[0].polygons){
      for(var i in obj_nine.rigidBodies[0].polygons[j]){
        obj_nine.rigidBodies[0].polygons[j][i].x *= 40;
        obj_nine.rigidBodies[0].polygons[j][i].y *= -40;
      }
      bdy = new Body(global_game, { color: "red", shape: "polygon", type: "static",height: 5, width: 120,
                          points: obj_nine.rigidBodies[0].polygons[j].reverse(),
                          x: x + 158, y: y+ 76})
      this.game_objects.push(bdy);
      bdy.tp = "nodraw";
    }

    var obj_ten ={"rigidBodies":[{"name":"Name","imagePath":"../pcs/10.png","origin":{"x":0,"y":0},"polygons":[[{"x":0.5050000548362732,"y":0.01625007577240467},{"x":0.64000004529953,"y":0.003750026458874345},{"x":0.7549999952316284,"y":0.03625005856156349}],[{"x":0.9699999690055847,"y":0.29875004291534424},{"x":0.98499995470047,"y":0.3537500202655792},{"x":0.9750000238418579,"y":0.36125001311302185},{"x":0.925000011920929,"y":0.3437500298023224},{"x":0.9200000166893005,"y":0.3112500309944153}],[{"x":0.7825000882148743,"y":0.15625004470348358},{"x":0.7775000333786011,"y":0.18125002086162567},{"x":0.0899999812245369,"y":0.18375001847743988},{"x":0.08750004321336746,"y":0.1337500661611557},{"x":0.13500000536441803,"y":0.05875003710389137},{"x":0.1849999874830246,"y":0.013750077225267887},{"x":0.5050000548362732,"y":0.01625007577240467},{"x":0.7549999952316284,"y":0.03625005856156349}],[{"x":0.7549999952316284,"y":0.03625005856156349},{"x":0.862500011920929,"y":0.05875003710389137},{"x":0.925000011920929,"y":0.13875003159046173},{"x":0.9425000548362732,"y":0.1912500411272049},{"x":0.85999995470047,"y":0.1912500411272049},{"x":0.7825000882148743,"y":0.15625004470348358}],[{"x":0.9425000548362732,"y":0.1912500411272049},{"x":0.9099999666213989,"y":0.2487500160932541},{"x":0.85999995470047,"y":0.1912500411272049}],[{"x":0.9425000548362732,"y":0.1912500411272049},{"x":0.9699999690055847,"y":0.29875004291534424},{"x":0.9200000166893005,"y":0.3112500309944153},{"x":0.9099999666213989,"y":0.2487500160932541}],[{"x":0.08750004321336746,"y":0.1337500661611557},{"x":0.03749999776482582,"y":0.1287500411272049},{"x":0.02000001259148121,"y":0.10625002533197403},{"x":0.07999999076128006,"y":0.05875003710389137},{"x":0.13500000536441803,"y":0.05875003710389137}]],"circles":[],"shapes":[{"type":"POLYGON","vertices":[{"x":0.02000001259148121,"y":0.10625002533197403},{"x":0.03749999776482582,"y":0.1287500411272049},{"x":0.08750004321336746,"y":0.1337500661611557},{"x":0.0899999812245369,"y":0.18375001847743988},{"x":0.7775000333786011,"y":0.18125002086162567},{"x":0.7825000882148743,"y":0.15625004470348358},{"x":0.85999995470047,"y":0.1912500411272049},{"x":0.9099999666213989,"y":0.2487500160932541},{"x":0.9200000166893005,"y":0.3112500309944153},{"x":0.925000011920929,"y":0.3437500298023224},{"x":0.9750000238418579,"y":0.36125001311302185},{"x":0.98499995470047,"y":0.3537500202655792},{"x":0.9699999690055847,"y":0.29875004291534424},{"x":0.9425000548362732,"y":0.1912500411272049},{"x":0.925000011920929,"y":0.13875003159046173},{"x":0.862500011920929,"y":0.05875003710389137},{"x":0.7549999952316284,"y":0.03625005856156349},{"x":0.64000004529953,"y":0.003750026458874345},{"x":0.5050000548362732,"y":0.01625007577240467},{"x":0.1849999874830246,"y":0.013750077225267887},{"x":0.13500000536441803,"y":0.05875003710389137},{"x":0.07999999076128006,"y":0.05875003710389137}]}]}],"dynamicObjects":[]};
    for(var j in obj_ten.rigidBodies[0].polygons){
      for(var i in obj_ten.rigidBodies[0].polygons[j]){
        obj_ten.rigidBodies[0].polygons[j][i].x *= 72;
        obj_ten.rigidBodies[0].polygons[j][i].y *= -72;
      }
      bdy = new Body(global_game, { color: "red", shape: "polygon", type: "static",height: 5, width: 120,
                          points: obj_ten.rigidBodies[0].polygons[j].reverse(),
                          x: x + 116, y: y+ 61})
      this.game_objects.push(bdy);
      bdy.tp = "nodraw";
    }

    var obj_eleven ={"rigidBodies":[{"name":"Name","imagePath":"../p/1.png","origin":{"x":0,"y":0},"polygons":[[{"x":0.38257575035095215,"y":0.888257622718811},{"x":0.3787878751754761,"y":1.2367424964904785},{"x":0.2878788113594055,"y":1.2291667461395264},{"x":0.2950000464916229,"y":0.8037499785423279}],[{"x":0.9074999690055847,"y":0.07125002890825272},{"x":0,"y":0.0687500610947609},{"x":-5.9604644775390625E-8,"y":0.0018939077854156494},{"x":0.9886363744735718,"y":0.009469687938690186}],[{"x":0.9886363744735718,"y":0.009469687938690186},{"x":0.9924243688583374,"y":0.8806818723678589},{"x":0.9175000786781311,"y":0.7987499833106995},{"x":0.9074999690055847,"y":0.07125002890825272}],[{"x":0.9924243688583374,"y":0.8806818723678589},{"x":0.38257575035095215,"y":0.888257622718811},{"x":0.2950000464916229,"y":0.8037499785423279},{"x":0.9175000786781311,"y":0.7987499833106995}]],"circles":[],"shapes":[{"type":"POLYGON","vertices":[{"x":0,"y":0.0687500610947609},{"x":0.9074999690055847,"y":0.07125002890825272},{"x":0.9175000786781311,"y":0.7987499833106995},{"x":0.2950000464916229,"y":0.8037499785423279},{"x":0.2878788113594055,"y":1.2291667461395264},{"x":0.3787878751754761,"y":1.2367424964904785},{"x":0.38257575035095215,"y":0.888257622718811},{"x":0.9924243688583374,"y":0.8806818723678589},{"x":0.9886363744735718,"y":0.009469687938690186},{"x":-5.9604644775390625E-8,"y":0.0018939077854156494}]}]}],"dynamicObjects":[]};
    for(var j in obj_eleven.rigidBodies[0].polygons){
      for(var i in obj_eleven.rigidBodies[0].polygons[j]){
        obj_eleven.rigidBodies[0].polygons[j][i].x *= 16;
        obj_eleven.rigidBodies[0].polygons[j][i].y *= -16;
      }
      bdy = new Body(global_game, { color: "red", shape: "polygon", type: "static",height: 5, width: 120,
                          points: obj_eleven.rigidBodies[0].polygons[j].reverse(),
                          x: x + 123.4, y: y+ 41})
      this.game_objects.push(bdy);
      bdy.tp = "nodraw";
    }

    var obj_twelve ={"rigidBodies":[{"name":"Name","imagePath":"../p/2.png","origin":{"x":0,"y":0},"polygons":[[{"x":0.5454545617103577,"y":0.763257622718811},{"x":0.011363625526428223,"y":0.759469747543335},{"x":0.08712118864059448,"y":0.7102272510528564},{"x":0.6174243092536926,"y":0.7102272510528564}],[{"x":0.6174243092536926,"y":0.7102272510528564},{"x":0.6174243092536926,"y":1.0549242496490479},{"x":0.549242377281189,"y":1.0587120056152344},{"x":0.5454545617103577,"y":0.763257622718811}],[{"x":0.011363625526428223,"y":0.759469747543335},{"x":-0.0037879347801208496,"y":0.009469687938690186},{"x":0.07954540848731995,"y":0.07386362552642822},{"x":0.08712118864059448,"y":0.7102272510528564}],[{"x":-0.0037879347801208496,"y":0.009469687938690186},{"x":0.9962121248245239,"y":-0.0018939375877380371},{"x":0.9924243688583374,"y":0.07007575035095215},{"x":0.07954540848731995,"y":0.07386362552642822}]],"circles":[],"shapes":[{"type":"POLYGON","vertices":[{"x":0.011363625526428223,"y":0.759469747543335},{"x":0.5454545617103577,"y":0.763257622718811},{"x":0.549242377281189,"y":1.0587120056152344},{"x":0.6174243092536926,"y":1.0549242496490479},{"x":0.6174243092536926,"y":0.7102272510528564},{"x":0.08712118864059448,"y":0.7102272510528564},{"x":0.07954540848731995,"y":0.07386362552642822},{"x":0.9924243688583374,"y":0.07007575035095215},{"x":0.9962121248245239,"y":-0.0018939375877380371},{"x":-0.0037879347801208496,"y":0.009469687938690186}]}]}],"dynamicObjects":[]};
    for(var j in obj_twelve.rigidBodies[0].polygons){
      for(var i in obj_twelve.rigidBodies[0].polygons[j]){
        obj_twelve.rigidBodies[0].polygons[j][i].x *= 19;
        obj_twelve.rigidBodies[0].polygons[j][i].y *= -19;
      }
      bdy = new Body(global_game, { color: "red", shape: "polygon", type: "static",height: 5, width: 120,
                          points: obj_twelve.rigidBodies[0].polygons[j].reverse(),
                          x: x + 152.5, y: y+ 41})
      this.game_objects.push(bdy);
      bdy.tp = "nodraw";
    }

      bdy = new Body(global_game, { color: "red", type: "static", x:x+ 145.5, y:y+ 20.5, height: 1, width: 11 })
      this.game_objects.push(bdy);
      bdy.tp = "nodraw";

    var obj_thirteen ={"rigidBodies":[{"name":"Name","imagePath":"../p/3.png","origin":{"x":0,"y":0},"polygons":[[{"x":0.9015151858329773,"y":0.19886362552642822},{"x":-5.9604644775390625E-8,"y":0.18371209502220154},{"x":0.0984848141670227,"y":0.11174237728118896},{"x":0.9962121248245239,"y":0.11174237728118896}],[{"x":0.9962121248245239,"y":0.11174237728118896},{"x":0.9962121248245239,"y":0.6155303120613098},{"x":0.9090909957885742,"y":0.5359848141670227},{"x":0.9015151858329773,"y":0.19886362552642822}],[{"x":0.9962121248245239,"y":0.6155303120613098},{"x":0.6439393162727356,"y":0.6079546213150024},{"x":0.6439393162727356,"y":0.5359848141670227},{"x":0.9090909957885742,"y":0.5359848141670227}],[{"x":-5.9604644775390625E-8,"y":0.18371209502220154},{"x":0.0037878453731536865,"y":0.005681842565536499},{"x":0.09090909361839294,"y":0.009469687938690186},{"x":0.0984848141670227,"y":0.11174237728118896}]],"circles":[],"shapes":[{"type":"POLYGON","vertices":[{"x":0.0037878453731536865,"y":0.005681842565536499},{"x":-5.9604644775390625E-8,"y":0.18371209502220154},{"x":0.9015151858329773,"y":0.19886362552642822},{"x":0.9090909957885742,"y":0.5359848141670227},{"x":0.6439393162727356,"y":0.5359848141670227},{"x":0.6439393162727356,"y":0.6079546213150024},{"x":0.9962121248245239,"y":0.6155303120613098},{"x":0.9962121248245239,"y":0.11174237728118896},{"x":0.0984848141670227,"y":0.11174237728118896},{"x":0.09090909361839294,"y":0.009469687938690186}]}]}],"dynamicObjects":[]};
     for(var j in obj_thirteen.rigidBodies[0].polygons){
      for(var i in obj_thirteen.rigidBodies[0].polygons[j]){
        obj_thirteen.rigidBodies[0].polygons[j][i].x *= 14;
        obj_thirteen.rigidBodies[0].polygons[j][i].y *= -14;
      }
      bdy = new Body(global_game, { color: "red", shape: "polygon", type: "static",height: 5, width: 120,
                          points: obj_thirteen.rigidBodies[0].polygons[j].reverse(),
                          x: x + 128.2, y: y+15.7})
      this.game_objects.push(bdy);
      bdy.tp = "nodraw";
    }

    var obj_fourteen={"rigidBodies":[{"name":"Name","imagePath":"../p/4.png","origin":{"x":0,"y":0},"polygons":[[{"x":0.9204546213150024,"y":0.08901515603065491},{"x":0.9318181872367859,"y":0.01325756311416626},{"x":0.9924243688583374,"y":0.009469687938690186},{"x":0.9848485589027405,"y":0.17234843969345093}],[{"x":0.07954540848731995,"y":0.467803031206131},{"x":0.2878788113594055,"y":0.467803031206131},{"x":0.28409090638160706,"y":0.5284091234207153},{"x":-5.9604644775390625E-8,"y":0.5208333730697632}],[{"x":-5.9604644775390625E-8,"y":0.5208333730697632},{"x":-5.9604644775390625E-8,"y":0.10795453190803528},{"x":0.08712118864059448,"y":0.17992424964904785},{"x":0.07954540848731995,"y":0.467803031206131}],[{"x":-5.9604644775390625E-8,"y":0.10795453190803528},{"x":0.9204546213150024,"y":0.08901515603065491},{"x":0.9848485589027405,"y":0.17234843969345093},{"x":0.08712118864059448,"y":0.17992424964904785}]],"circles":[],"shapes":[{"type":"POLYGON","vertices":[{"x":-5.9604644775390625E-8,"y":0.5208333730697632},{"x":0.28409090638160706,"y":0.5284091234207153},{"x":0.2878788113594055,"y":0.467803031206131},{"x":0.07954540848731995,"y":0.467803031206131},{"x":0.08712118864059448,"y":0.17992424964904785},{"x":0.9848485589027405,"y":0.17234843969345093},{"x":0.9924243688583374,"y":0.009469687938690186},{"x":0.9318181872367859,"y":0.01325756311416626},{"x":0.9204546213150024,"y":0.08901515603065491},{"x":-5.9604644775390625E-8,"y":0.10795453190803528}]}]}],"dynamicObjects":[]};
    for(var j in obj_fourteen.rigidBodies[0].polygons){
      for(var i in obj_fourteen.rigidBodies[0].polygons[j]){
        obj_fourteen.rigidBodies[0].polygons[j][i].x *= 16;
        obj_fourteen.rigidBodies[0].polygons[j][i].y *= -16;
      }
      bdy = new Body(global_game, { color: "red", shape: "polygon", type: "static",height: 5, width: 120,
                          points: obj_fourteen.rigidBodies[0].polygons[j].reverse(),
                          x: x + 148.2, y: y+15.7})
      this.game_objects.push(bdy);
      bdy.tp = "nodraw";
    }

      bdy = new Body(global_game, { color: "red", type: "static", x:x+ 145.5, y:y+ 20.5, height: 1, width: 11 })
      this.game_objects.push(bdy);
      bdy.tp = "nodraw";

    y = y;
    x = x + 140;

    spawnloc = [[115, 100],
                [115, 130],
                [110, 160],
                [150, 160],
                [170, 120],
                [245, 110],
                [245, 140],
                [230, 165],
                [275, 165]]

    loc = spawnloc[Math.floor(Math.random()*spawnloc.length)];

    //this.player = new player(global_game, { image: img_res('man.png'), x: x + 5, y:y +  8, width: 2.6 });
    //this.gun = new gun(global_game, { image: img_res('gun.png'), x: x + 6, y:y +  8.5, width: 4 , height: 1.5})

    this.player = new player(global_game, { image: img_res('man.png'), x: loc[0], y:loc[1], width: 2.6 });
    this.gun = new gun(global_game, { image: img_res('gun.png'), x: loc[0]+1, y:loc[1]+0.5, width: 4 , height: 1.5})

    this.player.m = true;
    this.gun.m = true;

    //this.player = new player(global_game, { color: "red", x: 5, y: 8, width: 2.6 });
    //this.gun = new gun(global_game, {color: "blue", x: x + 6, y:y +  8.5, width: 4 , height: 1.5})

    this.game_objects.push(this.player);
    this.game_objects.push(this.gun);

    def = new Box2D.Dynamics.Joints.b2RevoluteJointDef();
    def.Initialize(this.player.body,
                   this.gun.body,
                   new b2Vec2(loc[0],loc[1]+0.5));
    var joint = this.world.CreateJoint(def);

    this.start_handling();
    this.setup_collision_handler();

    socketSend();
}

game.prototype.create_box2d_world = function()
{
    var gravity = new b2Vec2(0, 2);
    var doSleep = false;
    var world = new b2World(gravity , doSleep);
    
    this.box2d_world = world;
}

game.prototype.start = function()
{
    this.on = true;
    this.total_points = 0;
    
    this.setup();
    this.is_paused = false;

    this.tick();
}

var img_main_b = img_res('main_b.png');
var img_main_f = img_res('main_f.png');
var img_bg = img_res('bg.png');
var img_heart = img_res('heart.png');
var img_boost = img_res('boost.png');
var img_ammu = img_res('ammu.png');
var img_arrow = img_res('arrow.png');
var lastm = 0;
var lmid = 0; 
var lmv = 0;

game.prototype.redraw_world = function()
{
        
    this.ctx.clearRect(0 , 0 , this.canvas_width, this.canvas_height);

    var w = this.screen_width;
    var h = this.screen_height;
    this.ctx.drawImage(img_bg, this.canvas.posx - w/2, this.canvas.posy - h/2, w, h);
    
    this.ctx.drawImage(img_main_b, 100 , 100 , 200, 80);
    
    for(var i in this.game_objects)
    {
        this.game_objects[i].draw(this.ctx);
    }

    var pl = global_game.player.body.GetPosition();

    if(!global_game.player.died){ 
      write_text({x : pl.x, y : pl.y - 2.2 , font : 'bold 0.9px Arial' , color : 'black' , text : global_game.name, ctx : this.ctx, align : "center"})
    }

    if(global_game.gun.showshoot >= 0){
          var offs = -0.1;
          var angle = global_game.gun.body.GetAngle();
          if(Math.cos(angle) < 0){offs = 0.1;}
          angle = global_game.gun.body.GetAngle()+offs;
          global_game.ctx.drawImage(global_game.gun.imgss, pl.x - 0.3 + (3.3 * Math.cos(angle))  , pl.y + (3.3 * Math.sin(angle)), 1, 1);
          global_game.gun.showshoot--;
        }

    plm = pl;

    for(var i in global_game.players){
      var pl = global_game.players[i].body.GetPosition();
      write_text({x : pl.x, y : pl.y - 2.2 , font : 'bold 0.9px Arial' , color : 'black' , text : global_game.players[i].name, ctx : this.ctx, align : "center"})
      if(global_game.players[i].gun.showshoot > 0){
          var offs = -0.1;
          var angle = global_game.players[i].gun.body.GetAngle();
          if(Math.cos(angle) < 0){offs = 0.1;}
          angle = global_game.players[i].gun.body.GetAngle()+offs;
          global_game.ctx.drawImage(global_game.gun.imgss, pl.x - 0.3 + (3.3 * Math.cos(angle))  , pl.y + (3.3 * Math.sin(angle)), 1, 1);
          global_game.players[i].gun.showshoot--;

          // Draw arrow
          d = (plm.y-pl.y)*(plm.y-pl.y) + (plm.x-pl.x)*(plm.x-pl.x);
          if(d > 400 && d < 10000){
            this.ctx.save();
            angle = 3.1415 + Math.atan2(plm.y-pl.y, plm.x-pl.x);
            this.ctx.translate(plm.x + (10 * Math.cos(angle))
                              ,plm.y + (10 * Math.sin(angle)));
            this.ctx.rotate(angle + (3.1415/4));
            global_game.ctx.drawImage(img_arrow ,0 ,0 , 3, 3);
            this.ctx.restore();
          }
        }
    }
        
    this.ctx.drawImage(img_main_f, 100 , 100 , 200, 80);

    // STATUS

    this.ctx.drawImage(img_heart, this.canvas.posx - w/2 + 1 , this.canvas.posy - h/2 + 1, 1, 1);
    this.ctx.drawImage(img_boost, this.canvas.posx - w/2 + 1 , this.canvas.posy - h/2 + 2.5, 1, 1);
    this.ctx.drawImage(img_ammu, this.canvas.posx - w/2 + 1 , this.canvas.posy - h/2 + 4, 1, 1);

    this.ctx.fillStyle="#f10400";
    this.ctx.fillRect(this.canvas.posx - w/2 + 2.5,this.canvas.posy - h/2 + 1.1 ,10 * (global_game.health / 100),0.8)

    this.ctx.beginPath();
    this.ctx.lineWidth = "0.1";
    this.ctx.strokeStyle = "#f10400";
    this.ctx.rect(this.canvas.posx - w/2 + 2.5,this.canvas.posy - h/2 + 1.1 ,10,0.8);  
    this.ctx.stroke();

    this.ctx.fillStyle="#446ae4";
    this.ctx.fillRect(this.canvas.posx - w/2 + 2.5,this.canvas.posy - h/2 + 2.6 ,10 * (global_game.booster / 100),0.8)

    this.ctx.beginPath();
    this.ctx.lineWidth = "0.1";
    this.ctx.strokeStyle = "#446ae4";
    this.ctx.rect(this.canvas.posx - w/2 + 2.5,this.canvas.posy - h/2 + 2.6 ,10,0.8);  
    this.ctx.stroke();

    this.ctx.fillStyle="#1d1d1b";
    this.ctx.fillRect(this.canvas.posx - w/2 + 2.5,this.canvas.posy - h/2 + 4.1 ,10 * (global_game.ammunition / 100),0.8)

    this.ctx.beginPath();
    this.ctx.lineWidth = "0.1";
    this.ctx.strokeStyle = "#1d1d1b";
    this.ctx.rect(this.canvas.posx - w/2 + 2.5,this.canvas.posy - h/2 + 4.1 ,10,0.8);  
    this.ctx.stroke();

    write_text({x : this.canvas.posx - w/2 + 2.5, y : this.canvas.posy - h/2 + 6 , font : 'bold 0.9px Arial' , color : "#1d1d1b" , text : String(Math.round(global_game.gun.adetails.rpc * global_game.ammunition / 100)) + "/" + String(global_game.gun.adetails.c), ctx : this.ctx});

    if(global_game.gun.adetails.c <= 0 && global_game.ammunition <= 0){
        write_text({x : this.canvas.posx - w/2 + 2.5 + 10, y : this.canvas.posy - h/2 + 6 , font : 'bold 0.9px Arial' , color : "red" , text : "NO AMMO", ctx : this.ctx, align : "right"});
    }else if(lsh == 1){
        write_text({x : this.canvas.posx - w/2 + 2.5 + 10, y : this.canvas.posy - h/2 + 6 , font : 'bold 0.9px Arial' , color : "#1d1d1b" , text : "RELOADING", ctx : this.ctx, align : "right"});
    }
    if(messages.length > lmid){
      write_text({x : this.canvas.posx, y : this.canvas.posy + h/2.5 , font : 'bold 1.4px Arial' , color : 'red' , text : messages[lmid], ctx : this.ctx, align : "center"});
      
      if(lmv == 0){
        lmv = 1;
        lastm = this.time_elapsed;
      }

      if(lmv == 1 && this.time_elapsed-lastm > 180){
      lmid++;
      lmv = 0;
      }

    }

    if(dmv == 1){
    t = (global_game.time_elapsed-dmt)/60;
    write_text({x : this.canvas.posx, y : this.canvas.posy - 3 , font : 'bold 3px Arial' , color : 'red' , text : "You died", ctx : this.ctx, align : "center"});
    write_text({x : this.canvas.posx, y : this.canvas.posy , font : 'bold 2px Arial' , color : 'red' , text : "Resurrection in " + Math.round(10 - t) + " seconds", ctx : this.ctx, align : "center"});
    }
}

game.prototype.tick = function(cnt) {
    var target_x = 0;
    var target_y = 0;
    target_x = this.player.body.GetPosition().x + 2 * Math.cos(global_game.gun.body.GetAngle());
    target_y = this.player.body.GetPosition().y + 2 * Math.sin(global_game.gun.body.GetAngle());
    if(global_game.player.died){
          target_x = this.canvas.posx;
          target_y = this.canvas.posy;
      }
    
    this.ctx.translate(this.canvas.posx - target_x, this.canvas.posy - target_y);
    
    this.canvas.posx = target_x;
    this.canvas.posy = target_y;
    this.key_down();
    this.key_up();
    if (!this.is_paused && this.on) {
        this.time_elapsed += 1;
        for (var i in this.game_objects) {
            if (this.game_objects[i].dead == true) {
                delete this.game_objects[i];
                continue;
            }
            this.game_objects[i].tick();
        }
        this.perform_destroy();
        this.box2d_world.Step(1 / 20, 8, 3);
        this.box2d_world.ClearForces();
        this.redraw_world();
        if (this.time_elapsed % 10) {
            socketSend();
        }
        if (this.time_elapsed % 100 == 0 && global_game.health < 100) {
            global_game.health++;
        }
        if (!this.is_paused && this.on) {
            var that = this;
            this.timer = setTimeout(function() {
                that.tick();
            }, 1000 / this.fps);
        }
    }
    if(lsh == 1 && global_game.gun.adetails.c > 0 && (global_game.time_elapsed - lst)/60 > global_game.gun.adetails.rldt){
              lst = global_game.time_elapsed;
              global_game.ammunition = 100;
              global_game.gun.adetails.c-=1;
              lsh = 0;
    }
}

game.prototype.perform_destroy = function()
  {
    for(var i in this.to_destroy)
    {
      this.to_destroy[i].destroy();
    }
  }


game.prototype.get_offset = function(vector)
  {
      return new b2Vec2(vector.x - 0, Math.abs(vector.y - this.screen_height));
  }

game.prototype.destroy_object = function(obj)
  {
    this.to_destroy.push(obj);
  }

game.prototype.start_handling = function()
  {
      var that = this;
      
      $(document).on('keydown.game' , function(e)
      {
          global_game.keys[e.keyCode] = e.type == 'keydown';
          that.key_down();
          return false;
      });
      
      $(document).on('keyup.game' ,function(e)
      {
          global_game.keys[e.keyCode] = e.type == 'keydown';
          that.key_up();
          return false;
      });
  }

lst = 0;
lsh = 0;

game.prototype.key_down = function()
  {
      if(global_game.player.died){return;}
      if(global_game.keys[37] || global_game.keys[65] )
      {
          this.player.do_move_left = true;
      }

      if(global_game.keys[38]  || global_game.keys[87] )
      {
          this.player.do_move_up = true;
      }

      if(global_game.keys[39]  || global_game.keys[68] )
      {
          this.player.do_move_right = true;
      }
      if(global_game.keys[32] )
      {
          if(global_game.ammunition > 0 && lsh == 0 && ((global_game.time_elapsed - lst)/60) > (60/global_game.gun.adetails.rpm)){
            global_game.gun.shoot();
            global_game.ammunition-=(100/global_game.gun.adetails.rpc);
            lst = global_game.time_elapsed;
          }

          if(global_game.ammunition <= 0){
            global_game.ammunition = 0;

            if(lsh == 0){
              lst = global_game.time_elapsed;
              lsh = 1;
            }
            if(lsh == 1 && global_game.gun.adetails.c > 0 && (global_game.time_elapsed - lst)/60 > global_game.gun.adetails.rldt){
              lst = global_game.time_elapsed;
              global_game.ammunition = 100;
              global_game.gun.adetails.c-=1;
              lsh = 0;
            }
          }
      }

  }

game.prototype.key_up = function()
  {
      if(global_game.player.died){return;}
      if(!global_game.keys[38]  && !global_game.keys[87] )
      {
          this.player.do_move_up = false;
      }

      if(!global_game.keys[37] && !global_game.keys[65] )
      {
          this.player.do_move_left = false;
      }

      if(!global_game.keys[39]  && !global_game.keys[68] )
      {
          this.player.do_move_right = false;
      }
  }

game.prototype.setup_collision_handler = function()
  {
    var that = this;

    b2ContactListener.prototype.BeginContact = function (contact) 
    {

      var a = contact.GetFixtureA().GetUserData();
      var b = contact.GetFixtureB().GetUserData();
      if(a instanceof Body && b instanceof Body)
      {
        if (a.tp == "bullet" && b.tp == "bullet"){that.destroy_object(a);}
        else if(a.tp == "bullet"){that.destroy_object(a);}
        else if(b.tp == "bullet"){that.destroy_object(b);}
      }

      else if(a instanceof Body && ( b instanceof player ||  b instanceof gun )){
        if(a.tp == "bullet"){that.destroy_object(a);
          if(b.m && global_game.health > 0 && !a.mp){
            global_game.health--;
            if(global_game.health < 5){
              global_game.player.dieded(a.name);
            }
          }
        }else if(a.tp == "dend"){
          global_game.player.sudieded();
        }
      }

      else if(b instanceof Body && ( a instanceof player ||  a instanceof gun )){
        if(b.tp == "bullet"){that.destroy_object(b);
          if(a.m && global_game.health > 0 && !b.mp){
            global_game.health--;
            if(global_game.health < 5){
              global_game.player.dieded(b.name);
            }
          }
        }else if(b.tp == "dend"){
          global_game.player.sudieded();
        } 
      }
    }
  }

// BODY

var Body = window.Body = function(physics,details) {
    this.details = details = details || {};

    this.definition = new b2BodyDef();
    this.age = 0;
    this.tp = "wall";

    for(var k in this.definitionDefaults) {
      this.definition[k] = details[k] || this.definitionDefaults[k];
    }

    this.definition.position = new b2Vec2(details.x || 0, details.y || 0);
    this.definition.linearVelocity = new b2Vec2(details.vx || 0, details.vy || 0);
    this.definition.userData = this;
    this.definition.type = details.type == "static" ? b2Body.b2_staticBody :
                                                      b2Body.b2_dynamicBody;

    this.body = physics.world.CreateBody(this.definition);


    this.fixtureDef = new b2FixtureDef();
    this.fixtureDef.userData = this;
    for(var l in this.fixtureDefaults) {
      this.fixtureDef[l] = details[l] || this.fixtureDefaults[l];
    }

    details.shape = details.shape || this.defaults.shape;

    switch(details.shape) {
      case "circle":
        details.radius = details.radius || this.defaults.radius;
        this.fixtureDef.shape = new b2CircleShape(details.radius);
        break;
      case "polygon":
        this.fixtureDef.shape = new b2PolygonShape();
        this.fixtureDef.shape.SetAsArray(details.points,details.points.length);
        break;
      case "block":
      default:
        details.width = details.width || this.defaults.width;
        details.height = details.height || this.defaults.height;

        this.fixtureDef.shape = new b2PolygonShape();
        this.fixtureDef.shape.SetAsBox(details.width/2,
                                       details.height/2);
        break;
    }

    this.body.CreateFixture(this.fixtureDef);
  };

Body.prototype.defaults = {
    shape: "block",
    width: 4,
    height: 4,
    radius: 1
  };

Body.prototype.fixtureDefaults = {
    density: 0,
    friction: 2,
    restitution: 0.2
  };

Body.prototype.definitionDefaults = {
    active: true,
    allowSleep: true,
    angle: 0,
    angularVelocity: 0,
    awake: true,
    bullet: true,
    fixedRotation: false
  };

Body.prototype.draw = function(context) {
    if(this.body == null || this.tp == "nodraw" || this.tp == "dend"){return;}
    var pos = this.body.GetPosition(),
        angle = this.body.GetAngle();

    context.save();
    context.translate(pos.x,pos.y);
    context.rotate(angle);

    if(this.details.color) {
      context.fillStyle = this.details.color;

      switch(this.details.shape) {
        case "circle":
          context.beginPath();
          context.arc(0,0,this.details.radius,0,Math.PI*2);
          context.fill();
          break;
        case "polygon":
          var points = this.details.points;
          context.beginPath();
          context.moveTo(points[0].x,points[0].y);
          for(var i=1;i<points.length;i++) {
            context.lineTo(points[i].x,points[i].y);
          }
          context.fill();
          break;
        case "block":
          context.fillRect(-this.details.width/2,
                           -this.details.height/2,
                           this.details.width,
                           this.details.height);
        default:
          break;
      }
    }

    if(this.details.image) {
      context.drawImage(this.details.image,
                        -this.details.width/2,
                        -this.details.height/2,
                        this.details.width,
                        this.details.height);

    }
    context.translate(-pos.x,-pos.y);
    context.restore();
  }

Body.prototype.tick = function()
  {
      this.age++;
  }

Body.prototype.add_velocity = function(vel)
  {
      var b = this.body;
      var v = b.GetLinearVelocity();
      
      v.Add(vel);
      
      if(Math.abs(v.y) > this.max_ver_vel){
          v.y = this.max_ver_vel * v.y/Math.abs(v.y);
      }
      
      if(Math.abs(v.x) > this.max_hor_vel){
          v.x = this.max_hor_vel * v.x/Math.abs(v.x);
      }

      b.SetLinearVelocity(v);
  }

Body.prototype.destroy = function()
  {
    if(this.body == null)
    {
      return;
    }
    this.body.GetWorld().DestroyBody( this.body );
    this.body = null;
    this.dead = true;
  }


// PLAYER

var player = function(physics,details) {
    this.details = details = details || {};

    this.definition = new b2BodyDef();
    this.died = false;

    for(var k in this.definitionDefaults) {
      this.definition[k] = details[k] || this.definitionDefaults[k];
    }
    this.definition.position = new b2Vec2(details.x || 0, details.y || 0);
    this.definition.linearVelocity = new b2Vec2(details.vx || 0, details.vy || 0);
    this.definition.userData = this;
    this.definition.type = details.type == "static" ? b2Body.b2_staticBody :
                                                      b2Body.b2_dynamicBody;

    this.body = physics.world.CreateBody(this.definition);
    this.fixtureDef = new b2FixtureDef();
    this.fixtureDef.userData = this;
    for(var l in this.fixtureDefaults) {
      this.fixtureDef[l] = details[l] || this.fixtureDefaults[l];
    }

    this.age = 0;      
    this.do_move_left = false;
    this.do_move_right = false;
    this.max_hor_vel = 4;
    this.max_ver_vel = 10;
    this.can_move_up = true;

    details.shape = details.shape || this.defaults.shape;

    switch(details.shape) {
      case "circle":
        details.radius = details.radius || this.defaults.radius;
        this.fixtureDef.shape = new b2CircleShape(details.radius);
        break;
      case "polygon":
        this.fixtureDef.shape = new b2PolygonShape();
        this.fixtureDef.shape.SetAsArray(details.points,details.points.length);
        break;
      case "block":
      default:
        details.width = details.width || this.defaults.width;
        details.height = details.height || this.defaults.height;

        this.fixtureDef.shape = new b2PolygonShape();
        this.fixtureDef.shape.SetAsBox(details.width/2,
                                       details.height/2);
        break;
    }

    this.body.CreateFixture(this.fixtureDef);
  };

player.prototype.defaults = {
    shape: "block",
    width: 4,
    height: 4,
    radius: 1
  };

player.prototype.fixtureDefaults = {
    density: 2000,
    friction: 0.2,
    restitution: 0.2
  };

player.prototype.definitionDefaults = {
    active: true,
    allowSleep: true,
    angle: 0,
    angularVelocity: 0,
    awake: true,
    bullet: false,
    fixedRotation: true
  };

player.prototype.draw = function(context) {
  if(this.died){return;}
    var pos = this.body.GetPosition(),
        angle = this.body.GetAngle();

    context.save();
    context.translate(pos.x,pos.y);
    context.rotate(angle);

    if(this.details.color) {
      context.fillStyle = this.details.color;

      switch(this.details.shape) {
        case "circle":
          context.beginPath();
          context.arc(0,0,this.details.radius,0,Math.PI*2);
          context.fill();
          break;
        case "polygon":
          var points = this.details.points;
          context.beginPath();
          context.moveTo(points[0].x,points[0].y);
          for(var i=1;i<points.length;i++) {
            context.lineTo(points[i].x,points[i].y);
          }
          context.fill();
          break;
        case "block":
          context.fillRect(-this.details.width/2,
                           -this.details.height/2,
                           this.details.width,
                           this.details.height);
        default:
          break;
      }
    }

    if(this.details.image) {
      context.drawImage(this.details.image,
                        -this.details.width/2,
                        -this.details.height/2,
                        this.details.width,
                        this.details.height);

    }
    context.restore();
  }

var dmv = 0;
var dmt = 0;
player.prototype.tick = function()
  {    
      if(this.do_move_left)
      {
          this.add_velocity(new b2Vec2(-1,0));
      }
      
      if(this.do_move_right)
      {
          this.add_velocity(new b2Vec2(1,0));
      }
      
      if(this.do_move_up)
      {
          if(global_game.booster > 0){
          this.add_velocity(new b2Vec2(0,-0.2));
          global_game.booster-=0.2;
          }
      }else if(this.age % 20 == 0 && global_game.booster < 100){
        global_game.booster++;
      }

      if(this.body.GetLinearVelocity().y <= 0.1 && Math.abs(this.body.GetAngle()) > 0.5){
        this.body.SetAngle(0);
        this.body.SetAngularVelocity(0);
      }

      if(this.died){
        
        if(dmv == 0){
          dmv = 1;
          dmt = global_game.time_elapsed;
          global_game.player.body.SetPosition(new b2Vec2(10, 10));
          global_game.socket.emit('game', {name : global_game.name, plposx : 10,  plposy : 10, gunang: 0, bull: 0}); 
        }

        if(dmv == 1 && global_game.time_elapsed-dmt > 600){
        this.died = false;
        global_game.health = 100;
        global_game.booster = 100;
        dmv = 0;

        spawnloc = [[115, 100],
                [115, 130],
                [110, 160],
                [150, 160],
                [170, 120],
                [245, 110],
                [245, 140],
                [230, 165],
                [275, 165]]

          loc = spawnloc[Math.floor(Math.random()*spawnloc.length)];
          global_game.player.body.SetPosition(new b2Vec2(loc[0], loc[1]));
          global_game.player.body.SetLinearVelocity(new b2Vec2(0,0));
          lastmess = 0;
          socketSend();

        }

      }
      
      this.age++;
  }

player.prototype.add_velocity = function(vel)
{
    var b = this.body;
    var v = b.GetLinearVelocity();
    
    v.Add(vel);

    if(Math.abs(v.y) > this.max_ver_vel)
    {
        v.y = this.max_ver_vel * v.y/Math.abs(v.y);
    }
    
    if(Math.abs(v.x) > this.max_hor_vel)
    {
        v.x = this.max_hor_vel * v.x/Math.abs(v.x);
    }

    b.SetLinearVelocity(v);
}

player.prototype.dieded = function(killer)
{
  socketMessage(killer +" killed "+global_game.name);
  this.died = true;
}

player.prototype.sudieded = function(killer)
{
  socketMessage(global_game.name +" committed suicide");
  this.died = true;
}



// GUN

var gun = function(physics,details) {
    this.details = details = details || {};

    this.definition = new b2BodyDef();
    this.age = 0;
    this.showshoot = 0;
    this.bull = 0;
    this.adetails = {
      rpm : 360,
      rpc : 80,
      c : 10,
      damage : 10,
      vel: 50,
      rldt: 2
    }

    for(var k in this.definitionDefaults) {
      this.definition[k] = details[k] || this.definitionDefaults[k];
    }
    this.definition.position = new b2Vec2(details.x || 0, details.y || 0);
    this.definition.linearVelocity = new b2Vec2(details.vx || 0, details.vy || 0);
    this.definition.userData = this;
    
    
    this.imgss = img_res('showfire.png');
    this.definition.type = details.type == "static" ? b2Body.b2_staticBody :
                                                      b2Body.b2_dynamicBody;

    this.details.image1 = img_res('rgun.png');
    this.details.image2 = img_res('gun.png');

    this.body = physics.world.CreateBody(this.definition);

    this.fixtureDef = new b2FixtureDef();
    this.fixtureDef.userData = this;
    for(var l in this.fixtureDefaults) {
      this.fixtureDef[l] = details[l] || this.fixtureDefaults[l];
    }


    details.shape = details.shape || this.defaults.shape;

    switch(details.shape) {
      case "circle":
        details.radius = details.radius || this.defaults.radius;
        this.fixtureDef.shape = new b2CircleShape(details.radius);
        break;
      case "polygon":
        this.fixtureDef.shape = new b2PolygonShape();
        this.fixtureDef.shape.SetAsArray(details.points,details.points.length);
        break;
      case "block":
      default:
        details.width = details.width || this.defaults.width;
        details.height = details.height || this.defaults.height;

        this.fixtureDef.shape = new b2PolygonShape();
        this.fixtureDef.shape.SetAsBox(details.width/2,
                                       details.height/2);
        break;
    }

    this.body.CreateFixture(this.fixtureDef);
  };


  gun.prototype.defaults = {
    shape: "block",
    width: 4,
    height: 4,
    radius: 1
  };

  gun.prototype.fixtureDefaults = {
    density: 0,
    friction: 2,
    restitution: 0.2
  };

  gun.prototype.definitionDefaults = {
    active: true,
    allowSleep: true,
    angle: 0,
    angularVelocity: 0,
    awake: true,
    bullet: false,
    fixedRotation: false
  };


  gun.prototype.draw = function(context) {
    if(global_game.player.died){return;}
    var pos = this.body.GetPosition(),
        angle = this.body.GetAngle();

    context.save();
    context.translate(pos.x,pos.y);
    context.rotate(angle);


    if(this.details.color) {
      context.fillStyle = this.details.color;

      switch(this.details.shape) {
        case "circle":
          context.beginPath();
          context.arc(0,0,this.details.radius,0,Math.PI*2);
          context.fill();
          break;
        case "polygon":
          var points = this.details.points;
          context.beginPath();
          context.moveTo(points[0].x,points[0].y);
          for(var i=1;i<points.length;i++) {
            context.lineTo(points[i].x,points[i].y);
          }
          context.fill();
          break;
        case "block":
          context.fillRect(-this.details.width/2,
                           -this.details.height/2,
                           this.details.width,
                           this.details.height);
        default:
          break;
      }
    }

    if(this.details.image) {
      context.drawImage(this.details.image,
                        -this.details.width/2,
                        -this.details.height/2,
                        this.details.width,
                        this.details.height);

    }
    context.restore();
  }

var pmx = 0;
var pmy = 0;

gun.prototype.tick = function()
  {
      $(canvas).mousemove(function(e) 
      {
          if((pmx == 0 && pmy == 0) || (Math.abs(pmx-e.pageX)) > 10 || (Math.abs(pmy-e.pageY)) > 10 ){
            pmx = e.pageX;
            pmy = e.pageY;
          scale = global_game.scale * (1/resolution);
          var pl = global_game.player.body.GetPosition();
          player_x = (pl.x - global_game.canvas.posx + global_game.canvas.w) * scale;
          player_y = (pl.y - global_game.canvas.posy + global_game.canvas.h) * scale;
          this.diffx = player_x-e.pageX;
          this.diffy = player_y-e.pageY;
          //this.diffx = (global_game.canvas_width * (1.318/2))-e.pageX;
          //this.diffy = (global_game.canvas_height * (1.318/2))-e.pageY;
          if(this.diffx > 0){
              global_game.gun.details.image = global_game.gun.details.image1;
          }else{
              global_game.gun.details.image = global_game.gun.details.image2;
          }
          global_game.gun.body.SetAngle(3.1415 + Math.atan2(this.diffy,this.diffx));
          
          this.age++;
        }
      });    
  }

gun.prototype.shoot = function()
  {
      var pl = global_game.player.body.GetPosition();
      var angle = global_game.gun.body.GetAngle() + (Math.random() - 0.5) * 0.05;
      this.bullet = new Body(global_game, { image: img_res('bullet.png'), x: pl.x + (4 * Math.cos(angle)), y: pl.y + (4 * Math.sin(angle)), width: 0.3, height: 0.2});
      this.bullet.tp = "bullet";
      this.bullet.mp = true;
      this.bullet.body.SetAngle(angle);
      global_game.game_objects.push(this.bullet);
      bullvel =50 + Math.random() * 50;
      this.bullet.add_velocity(new b2Vec2(bullvel * Math.cos(angle),bullvel * Math.sin(angle)));
      global_game.gun.showshoot = 1;
      this.bull++;
  }

// OPPONENTS GUN

var ogun = function(physics,details) {
    this.details = details = details || {};

    this.definition = new b2BodyDef();
    this.age = 0;
    this.showshoot = 0;

    for(var k in this.definitionDefaults) {
      this.definition[k] = details[k] || this.definitionDefaults[k];
    }
    this.definition.position = new b2Vec2(details.x || 0, details.y || 0);
    this.definition.linearVelocity = new b2Vec2(details.vx || 0, details.vy || 0);
    this.definition.userData = this;
    
    
    this.imgss = img_res('showfire.png');
    this.definition.type = details.type == "static" ? b2Body.b2_staticBody :
                                                      b2Body.b2_dynamicBody;

    this.details.image1 = img_res('rgun.png');
    this.details.image2 = img_res('gun.png');

    this.body = physics.world.CreateBody(this.definition);

    this.fixtureDef = new b2FixtureDef();
    for(var l in this.fixtureDefaults) {
      this.fixtureDef[l] = details[l] || this.fixtureDefaults[l];
    }


    details.shape = details.shape || this.defaults.shape;

    switch(details.shape) {
      case "circle":
        details.radius = details.radius || this.defaults.radius;
        this.fixtureDef.shape = new b2CircleShape(details.radius);
        break;
      case "polygon":
        this.fixtureDef.shape = new b2PolygonShape();
        this.fixtureDef.shape.SetAsArray(details.points,details.points.length);
        break;
      case "block":
      default:
        details.width = details.width || this.defaults.width;
        details.height = details.height || this.defaults.height;

        this.fixtureDef.shape = new b2PolygonShape();
        this.fixtureDef.shape.SetAsBox(details.width/2,
                                       details.height/2);
        break;
    }

    this.body.CreateFixture(this.fixtureDef);
  };


  ogun.prototype.defaults = {
    shape: "block",
    width: 4,
    height: 4,
    radius: 1
  };

  ogun.prototype.fixtureDefaults = {
    density: 0,
    friction: 2,
    restitution: 0.2
  };

  ogun.prototype.definitionDefaults = {
    active: true,
    allowSleep: true,
    angle: 0,
    angularVelocity: 0,
    awake: true,
    bullet: false,
    fixedRotation: false
  };


  ogun.prototype.draw = function(context) {
    var pos = this.body.GetPosition(),
        angle = this.body.GetAngle();

    context.save();
    context.translate(pos.x,pos.y);
    context.rotate(angle);


    if(this.details.color) {
      context.fillStyle = this.details.color;

      switch(this.details.shape) {
        case "circle":
          context.beginPath();
          context.arc(0,0,this.details.radius,0,Math.PI*2);
          context.fill();
          break;
        case "polygon":
          var points = this.details.points;
          context.beginPath();
          context.moveTo(points[0].x,points[0].y);
          for(var i=1;i<points.length;i++) {
            context.lineTo(points[i].x,points[i].y);
          }
          context.fill();
          break;
        case "block":
          context.fillRect(-this.details.width/2,
                           -this.details.height/2,
                           this.details.width,
                           this.details.height);
        default:
          break;
      }
    }

    if(this.details.image) {
      context.drawImage(this.details.image,
                        -this.details.width/2,
                        -this.details.height/2,
                        this.details.width,
                        this.details.height);

    }
    context.restore();
  }
ogun.prototype.tick = function()
  {
          if(Math.cos(this.body.GetAngle()) < 0){
              this.details.image = global_game.gun.details.image1;
          }else{
              this.details.image = global_game.gun.details.image2;
          }
          this.age++;   
  }

ogun.prototype.shoot = function(pl, ang)
  {
      var angle = ang + (Math.random() - 0.5) * 0.05;
      this.bullet = new Body(global_game, { image: img_res('bullet.png'), x: pl.x + (4 * Math.cos(angle)), y: pl.y + (4 * Math.sin(angle)), width: 0.3, height: 0.2});
      this.bullet.tp = "bullet";
      this.bullet.body.SetAngle(angle);
      this.bullet.mp = false;
      global_game.game_objects.push(this.bullet);
      bullvel =50 + Math.random() * 50;
      this.bullet.add_velocity(new b2Vec2(bullvel * Math.cos(angle),bullvel * Math.sin(angle)));
      this.showshoot = 1;
      this.bullet.name=this.name;
  }